# ‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó: CRM Backend –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É

## üìä –ó–∞–≥–∞–ª—å–Ω–∏–π —Å—Ç–∞—Ç—É—Å: ‚úÖ –ì–û–¢–û–í–û (–∑ –Ω–µ–≤–µ–ª–∏–∫–∏–º–∏ TODO)

–í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ endpoints —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —Ç–∞ –≥–æ—Ç–æ–≤—ñ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è. –ó–∞–ª–∏—à–∏–ª–∏—Å—å –Ω–µ–≤–µ–ª–∏–∫—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–ª—è –º–∞–ø—ñ–Ω–≥—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

---

## ‚úÖ –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û

### 1Ô∏è‚É£ –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø (JWT)

#### ‚úÖ 1.1. Endpoint: `POST /api/auth/login`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è—î email —Ç–∞ password
- ‚úÖ –ì–µ–Ω–µ—Ä—É—î JWT —Ç–æ–∫–µ–Ω
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (id, email, role)
- ‚úÖ –¢–æ–∫–µ–Ω –º—ñ—Å—Ç–∏—Ç—å `userId` —Ç–∞ `role` –≤ payload

#### ‚úÖ 1.2. Middleware: `authenticateJWT`
- ‚úÖ Middleware —ñ—Å–Ω—É—î (`admin-panel-backend/src/middleware/auth.ts`)
- ‚úÖ –ß–∏—Ç–∞—î —Ç–æ–∫–µ–Ω –∑ header: `Authorization: Bearer <token>`
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è—î –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å JWT —Ç–æ–∫–µ–Ω—É
- ‚úÖ –û—Ç—Ä–∏–º—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
- ‚úÖ –î–æ–¥–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ `req.user`
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î 401 —è–∫—â–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª—ñ–¥–Ω–∏–π

---

### 2Ô∏è‚É£ AMO CRM –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø (OAuth)

#### ‚úÖ 2.1. Endpoint: `GET /api/amo-crm/status`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ **–ù–ï –≤–∏–º–∞–≥–∞—î** `requireAdmin` (–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö)
- ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–æ–∫–µ–Ω–∏ –¥–ª—è **–ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (`user.id`)
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —Å—Ç–∞—Ç—É—Å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts` (—Ä—è–¥–æ–∫ 131)

#### ‚úÖ 2.2. Endpoint: `GET /api/amo-crm/callback`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –ü—Ä–∏–π–º–∞—î `code` —Ç–∞ `state` –∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
- ‚úÖ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ deep link `foryoure://amo-crm/callback?code=...`

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts` (—Ä—è–¥–æ–∫ 43)

#### ‚úÖ 2.3. Endpoint: `POST /api/amo-crm/exchange-code`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ –ü—Ä–∏–π–º–∞—î `{ code: string }` –≤ body
- ‚úÖ –û–±–º—ñ–Ω—é—î code –Ω–∞ —Ç–æ–∫–µ–Ω–∏ —á–µ—Ä–µ–∑ AMO CRM API
- ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏ –¥–ª—è **–ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (`user.id`)
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —É—Å–ø—ñ—à–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts` (—Ä—è–¥–æ–∫ 267)

#### ‚úÖ 2.4. Endpoint: `POST /api/amo-crm/disconnect`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ –í–∏–¥–∞–ª—è—î —Ç–æ–∫–µ–Ω–∏ –¥–ª—è **–ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** (`user.id`)
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —É—Å–ø—ñ—à–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts` (—Ä—è–¥–æ–∫ 285)

#### ‚úÖ 2.5. Entity: `AmoCrmToken`
- ‚úÖ Entity —ñ—Å–Ω—É—î
- ‚úÖ –ú–∞—î –ø–æ–ª–µ `user_id` (UUID, nullable –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤)
- ‚úÖ –ú–∞—î foreign key –Ω–∞ `users(id)`
- ‚úÖ –ú–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π partial index –Ω–∞ `user_id` (WHERE user_id IS NOT NULL)
- ‚úÖ –ú–∞—î –ø–æ–ª—è: `access_token`, `refresh_token`, `expires_at`, `token_type`

**–§–∞–π–ª:** `admin-panel-backend/src/entities/AmoCrmToken.ts`

---

### 3Ô∏è‚É£ AMO CRM PIPELINES & STAGES

#### ‚úÖ 3.1. Endpoint: `GET /api/amo-crm/pipelines`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ **–ù–ï –≤–∏–º–∞–≥–∞—î** `requireAdmin` (–¥–æ—Å—Ç—É–ø–Ω–∏–π –¥–ª—è –≤—Å—ñ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö)
- ‚úÖ –û—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω–∏ AMO CRM –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚úÖ –†–æ–±–∏—Ç—å –∑–∞–ø–∏—Ç –¥–æ AMO CRM API: `GET /api/v4/leads/pipelines`
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ pipelines –∑ stages

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts` (—Ä—è–¥–æ–∫ 108)

#### ‚úÖ 3.2. Endpoint: `GET /api/amo-crm/pipelines/:id/stages`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ –û—Ç—Ä–∏–º—É—î —Ç–æ–∫–µ–Ω–∏ AMO CRM –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚úÖ –û—Ç—Ä–∏–º—É—î stages –∑ –ª–æ–∫–∞–ª—å–Ω–æ—ó –ë–î –∞–±–æ AMO CRM API
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ stages –∑ –º–∞–ø—ñ–Ω–≥–æ–º —Å—Ç–∞—Ç—É—Å—ñ–≤ (`mappedStatus`)

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts` (—Ä—è–¥–æ–∫ 611)

---

### 4Ô∏è‚É£ LEADS (–û—Å–Ω–æ–≤–Ω—ñ Endpoints)

#### ‚úÖ 4.1. Endpoint: `GET /api/v1/leads`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ –û—Ç—Ä–∏–º—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ `req.user`
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º—É—î –ø–∞–≥—ñ–Ω–∞—Ü—ñ—é (page, limit)
- ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º—É—î —Ñ—ñ–ª—å—Ç—Ä–∏ (status)
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `AmoCrmLead` entity (AMO CRM leads)
- ‚úÖ –í–∏—Ç—è–≥—É—î –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∑ `AmoCrmContact`
- ‚úÖ –ú–∞–ø–∏—Ç—å —Å—Ç–∞—Ç—É—Å–∏ —á–µ—Ä–µ–∑ `AmoCrmStage.mappedStatus`
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î –¥–∞–Ω—ñ —É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ

**–§–∞–π–ª:** `admin-panel-backend/src/routes/leads.routes.ts` (—Ä—è–¥–æ–∫ 14)

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ `brokerId` –ø–æ—Ç—Ä–µ–±—É—î –º–∞–ø—ñ–Ω–≥—É –º—ñ–∂ `User.id` —Ç–∞ `AmoCrmUser.amoUserId` (TODO)

#### ‚úÖ 4.2. Endpoint: `GET /api/v1/leads/:id`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ –û—Ç—Ä–∏–º—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ `req.user`
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î 404 —è–∫—â–æ lead –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î –¥–∞–Ω—ñ —É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ

**–§–∞–π–ª:** `admin-panel-backend/src/routes/leads.routes.ts` (—Ä—è–¥–æ–∫ 217)

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–ª—è –±—Ä–æ–∫–µ—Ä—ñ–≤ –ø–æ—Ç—Ä–µ–±—É—î –º–∞–ø—ñ–Ω–≥—É (TODO)

#### ‚ö†Ô∏è 4.3. Entity: `Lead` vs `AmoCrmLead`
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `AmoCrmLead` entity
- ‚úÖ –î–∞–Ω—ñ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—é—Ç—å—Å—è –¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑ main backend —Ñ–æ—Ä–º–∞—Ç–æ–º
- ‚úÖ –í–∏—Ç—è–≥—É—î—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∑ `AmoCrmContact`

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –û–∫—Ä–µ–º–∞ entity `Lead` –Ω–µ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `AmoCrmLead` –∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –¥–∞–Ω–∏—Ö

---

### 5Ô∏è‚É£ –†–û–ó–®–ò–†–ï–ù–Ü –§–£–ù–ö–¶–Ü–á

#### ‚úÖ 5.1. Endpoint: `GET /api/v1/analytics/my-stats`
- ‚úÖ Endpoint —ñ—Å–Ω—É—î
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î middleware `authenticateJWT` (JWT)
- ‚úÖ –†–æ–∑—Ä–∞—Ö–æ–≤—É—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ leads (total, byStatus, totalPriceByStatus)

**–§–∞–π–ª:** `admin-panel-backend/src/routes/analytics.routes.ts` (—Ä—è–¥–æ–∫ 50)

**–ü—Ä–∏–º—ñ—Ç–∫–∞:** –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –ø–æ—Ç—Ä–µ–±—É—î –º–∞–ø—ñ–Ω–≥—É (TODO)

---

### 6Ô∏è‚É£ –ü–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø –î–û SERVER

#### ‚úÖ 6.1. –§–∞–π–ª: `admin-panel-backend/src/server.ts`
- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ routes –¥–ª—è auth: `app.use('/api/auth', authRoutes)`
- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ routes –¥–ª—è AMO CRM: `app.use('/api/amo-crm', amoCrmRoutes)`
- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ routes –¥–ª—è leads: `app.use('/api/v1/leads', leadsRoutes)`
- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ routes –¥–ª—è analytics: `app.use('/api/v1/analytics', analyticsRoutes)`

---

### 7Ô∏è‚É£ –ë–ê–ó–ê –î–ê–ù–ò–•

#### ‚úÖ 7.1. –¢–∞–±–ª–∏—Ü—ñ
- ‚úÖ –¢–∞–±–ª–∏—Ü—è `users` - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ (–∞–≥–µ–Ω—Ç–∏/–±—Ä–æ–∫–µ—Ä–∏)
- ‚úÖ –¢–∞–±–ª–∏—Ü—è `amo_crm_tokens` - —Ç–æ–∫–µ–Ω–∏ AMO CRM (–∑ `user_id`)
- ‚úÖ –¢–∞–±–ª–∏—Ü—è `amo_crm_leads` - leads –∑ AMO CRM
- ‚úÖ –¢–∞–±–ª–∏—Ü—è `amo_crm_pipelines` - pipelines –∑ AMO CRM
- ‚úÖ –¢–∞–±–ª–∏—Ü—è `amo_crm_stages` - stages –∑ AMO CRM
- ‚úÖ –¢–∞–±–ª–∏—Ü—è `amo_crm_contacts` - –∫–æ–Ω—Ç–∞–∫—Ç–∏ –∑ AMO CRM

#### ‚úÖ 7.2. –ú—ñ–≥—Ä–∞—Ü—ñ—ó
- ‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—è –¥–ª—è `amo_crm_tokens` –∑ –ø–æ–ª–µ–º `user_id` (009-add-user-id-to-amo-crm-tokens.sql)
- ‚úÖ –ú—ñ–≥—Ä–∞—Ü—ñ—è –¥–ª—è `amo_crm_leads` –∑ —É—Å—ñ–º–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–º–∏ –ø–æ–ª—è–º–∏ (008-create-amo-crm-entities-tables.sql)
- ‚úÖ –Ü–Ω–¥–µ–∫—Å–∏ –Ω–∞ –≤–∞–∂–ª–∏–≤—ñ –ø–æ–ª—è

---

### 8Ô∏è‚É£ –°–ï–†–í–Ü–°–ò

#### ‚úÖ 8.1. AmoCrmService
- ‚úÖ –ú–µ—Ç–æ–¥ `getUserConnectionStatus(userId: string)` - —Å—Ç–∞—Ç—É—Å –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚úÖ –ú–µ—Ç–æ–¥ `exchangeCodeForUser(userId: string, code: string)` - –æ–±–º—ñ–Ω –∫–æ–¥—É
- ‚úÖ –ú–µ—Ç–æ–¥ `saveTokensForUser(userId: string, authData: AmoAuthResponse)` - –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
- ‚úÖ –ú–µ—Ç–æ–¥ `disconnectUser(userId: string)` - –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- ‚úÖ –ú–µ—Ç–æ–¥ `getAccessToken(userId?: string)` - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω—É –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚úÖ –ú–µ—Ç–æ–¥ `getPipelines(userId?: string)` - –æ—Ç—Ä–∏–º–∞–Ω–Ω—è pipelines –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

**–§–∞–π–ª:** `admin-panel-backend/src/services/amo-crm.service.ts`

---

## ‚ö†Ô∏è TODO (–ú–∞–π–±—É—Ç–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è)

### 1. –ú–∞–ø—ñ–Ω–≥ –º—ñ–∂ User —Ç–∞ AmoCrmUser

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –î–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –ø–æ `brokerId` –ø–æ—Ç—Ä—ñ–±–Ω–æ –º–∞–ø–∏—Ç–∏ `User.id` ‚Üí `AmoCrmUser.amoUserId`
- –î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –±—Ä–æ–∫–µ—Ä—ñ–≤ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–Ω–∞—Ç–∏, —è–∫–∏–π `AmoCrmUser` –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î `User`

**–†—ñ—à–µ–Ω–Ω—è:**
- –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é `user_amo_mapping` –∞–±–æ –¥–æ–¥–∞—Ç–∏ –ø–æ–ª–µ `amo_user_id` –¥–æ `users`
- –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ AMO CRM –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –º–∞–ø—ñ–Ω–≥ –º—ñ–∂ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –º–∞–ø—ñ–Ω–≥ –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó leads –ø–æ `responsibleUserId`

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** –°–µ—Ä–µ–¥–Ω—ñ–π (–Ω–µ –±–ª–æ–∫—É—î —Ä–æ–±–æ—Ç—É, –∞–ª–µ –ø–æ–∫—Ä–∞—â–∏—Ç—å –±–µ–∑–ø–µ–∫—É)

---

### 2. –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è leads –¥–ª—è –±—Ä–æ–∫–µ—Ä—ñ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ó–∞—Ä–∞–∑ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –≤—Å—ñ leads
- –ü–æ—Ç—Ä—ñ–±–Ω–æ —Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –ø–æ `responsibleUserId` —á–µ—Ä–µ–∑ –º–∞–ø—ñ–Ω–≥

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü—ñ—Å–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–∞–ø—ñ–Ω–≥—É –¥–æ–¥–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é:
  ```typescript
  if (user.role === 'BROKER') {
    const amoUserId = await getAmoUserIdForUser(user.id);
    queryBuilder.andWhere('lead.responsibleUserId = :amoUserId', { amoUserId });
  }
  ```

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** –°–µ—Ä–µ–¥–Ω—ñ–π (–Ω–µ –±–ª–æ–∫—É—î —Ä–æ–±–æ—Ç—É, –∞–ª–µ –ø–æ–∫—Ä–∞—â–∏—Ç—å –±–µ–∑–ø–µ–∫—É)

---

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É –¥–ª—è –±—Ä–æ–∫–µ—Ä—ñ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ó–∞—Ä–∞–∑ –±—Ä–æ–∫–µ—Ä –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π lead —á–µ—Ä–µ–∑ `GET /api/v1/leads/:id`
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏, —á–∏ lead –Ω–∞–ª–µ–∂–∏—Ç—å –±—Ä–æ–∫–µ—Ä—É

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü—ñ—Å–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–∞–ø—ñ–Ω–≥—É –¥–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É:
  ```typescript
  if (user.role === 'BROKER') {
    const amoUserId = await getAmoUserIdForUser(user.id);
    if (lead.responsibleUserId !== amoUserId) {
      return res.status(403).json({ success: false, message: 'Forbidden' });
    }
  }
  ```

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:** –°–µ—Ä–µ–¥–Ω—ñ–π (–Ω–µ –±–ª–æ–∫—É—î —Ä–æ–±–æ—Ç—É, –∞–ª–µ –ø–æ–∫—Ä–∞—â–∏—Ç—å –±–µ–∑–ø–µ–∫—É)

---

## üìä –ü—ñ–¥—Å—É–º–æ–∫

### ‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
- –í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ endpoints —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î
- AMO CRM —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î
- Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∞—Ü—é—î

### ‚ö†Ô∏è –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è (–Ω–µ –±–ª–æ–∫—É—î —Ä–æ–±–æ—Ç—É):
- –ú–∞–ø—ñ–Ω–≥ –º—ñ–∂ User —Ç–∞ AmoCrmUser
- –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è leads –¥–ª—è –±—Ä–æ–∫–µ—Ä—ñ–≤
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

- **Leads Endpoint:** `LEADS_ENDPOINT_IMPLEMENTATION_SUMMARY.md`
- **AMO CRM Mobile Auth:** `AMO_CRM_MOBILE_AUTH_IMPLEMENTATION.md`
- **AMO CRM Complete:** `AMO_CRM_COMPLETE_DOCUMENTATION.md`
- **–ü–æ–≤–Ω—ñ –≤–∏–º–æ–≥–∏:** `CRM_FULL_BACKEND_REQUIREMENTS.md`

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –ì—Ä—É–¥–µ–Ω—å 2025

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å—ñ –æ—Å–Ω–æ–≤–Ω—ñ endpoints —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —Ç–∞ –≥–æ—Ç–æ–≤—ñ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** –ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –≤ production. TODO –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –º–æ–∂–Ω–∞ —Ä–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ.
