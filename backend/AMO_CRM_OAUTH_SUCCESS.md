# ‚úÖ AMO CRM OAuth Integration - –£–°–ü–Ü–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û

## üéâ –í–°–ï –ü–†–ê–¶–Æ–Ñ!

OAuth flow –¥–ª—è AMO CRM –ø–æ–≤–Ω—ñ—Å—Ç—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π. –í—Å—ñ –ø—Ä–æ–±–ª–µ–º–∏ –≤–∏—Ä—ñ—à–µ–Ω—ñ.

---

## üìã –§—ñ–Ω–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è

### –ü—ñ–¥—Ö—ñ–¥: –†—É—á–Ω–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ –¥–æ–¥–∞—Ç–æ–∫

1. **Backend –≤–µ—Ä–∏—Ñ—ñ–∫—É—î CRM** - –æ–±–º—ñ–Ω—é—î `code` –Ω–∞ —Ç–æ–∫–µ–Ω–∏ —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î —ó—Ö **–î–û** –ø–æ–∫–∞–∑—É HTML
2. **–ü–æ–∫–∞–∑—É—î –∫–Ω–æ–ø–∫—É "Return to App"** - –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ redirect
3. **–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∞–º –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É** - –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ –¥–æ–¥–∞—Ç–æ–∫
4. **CRM –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞** - –Ω–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–Ω–æ–≤—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è

---

## ‚úÖ –©–æ –±—É–ª–æ –≤–∏—Ä—ñ—à–µ–Ω–æ

### 1. –û–±–º—ñ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º HTML
- ‚úÖ `await amoCrmService.exchangeCode(code)` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è **–ü–ï–†–ï–î** `res.send()`
- ‚úÖ CRM –≤–µ—Ä–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –¥–æ –ø–æ–∫–∞–∑—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
- ‚úÖ –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ë–î –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### 2. –ü—Ä–∏–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π redirect
- ‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ —Å–ø—Ä–æ–±–∏ `location.href`, `window.location.replace`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∫–ª—ñ–∫
- ‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ `setTimeout` –¥–ª—è fallback
- ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–æ–Ω—Ç—Ä–æ–ª—é—î –ø—Ä–æ—Ü–µ—Å –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è

### 3. –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –æ–¥—Ä–∞–∑—É
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "Return to App" –≤–∏–¥–∏–º–∞ –≤—ñ–¥—Ä–∞–∑—É
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `<button onclick="window.open(...)">` –¥–ª—è Safari WebView
- ‚úÖ –ù–µ–º–∞—î –∑–∞—Ç—Ä–∏–º–æ–∫ –∞–±–æ –∑–∞–≤–∏—Å–∞–Ω—å

### 4. –û–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- ‚úÖ "‚úì Authorization successful!"
- ‚úÖ "Your AMO CRM account has been successfully connected."
- ‚úÖ –ß—ñ—Ç–∫—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

---

## üîÑ –ü–æ–≤–Ω–∏–π OAuth Flow (–ü–†–ê–¶–Æ–Ñ)

### –ö—Ä–æ–∫ 1: –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó ‚úÖ
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM" –≤ –º–æ–±—ñ–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É
2. –í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä (Safari) –∑ —Ñ–æ—Ä–º–æ—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó AMO CRM

### –ö—Ä–æ–∫ 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ AMO CRM ‚úÖ
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å AMO CRM
2. –ù–∞—Ç–∏—Å–∫–∞—î "–†–ê–ó–†–ï–®–ò–¢–¨" (ALLOW)

### –ö—Ä–æ–∫ 3: Callback –æ–±—Ä–æ–±–∫–∞ ‚úÖ
1. AMO CRM –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ `https://admin.foryou-realestate.com/api/amo-crm/callback?code=...`
2. Backend –æ–±—Ä–æ–±–ª—è—î callback:
   - **–û–±–º—ñ–Ω—é—î `code` –Ω–∞ —Ç–æ–∫–µ–Ω–∏** (–ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º HTML)
   - **–ó–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏ –≤ –ë–î**
   - –ü–æ–≤–µ—Ä—Ç–∞—î HTML —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ –∫–Ω–æ–ø–∫–æ—é "Return to App"
3. –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞:
   - "‚úì Authorization successful!"
   - "Your AMO CRM account has been successfully connected."
   - –ö–Ω–æ–ø–∫–∞ "Return to App"
4. **–ù–µ–º–∞—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ redirect** - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∞–º –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É

### –ö—Ä–æ–∫ 4: –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ –¥–æ–¥–∞—Ç–æ–∫ ‚úÖ
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É "Return to App"
2. –í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è deep link `foryoure://amo-crm/callback?code=...`
3. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î callback
4. –í–∏–∫–ª–∏–∫–∞—î `POST /api/amo-crm/exchange-code` –∑ JWT —Ç–æ–∫–µ–Ω–æ–º
5. Backend –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —â–æ —Ç–æ–∫–µ–Ω–∏ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ (–∞–±–æ –∑–±–µ—Ä—ñ–≥–∞—î –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞)
6. –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"
7. **CRM –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞** - –Ω–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–Ω–æ–≤—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

---

## üîë –ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏

### 1. –û–±–º—ñ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω–∏ –ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º HTML

**–ö–æ–¥:**
```typescript
// ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –°–ø–æ—á–∞—Ç–∫—É –æ–±–º—ñ–Ω—é—î–º–æ code –Ω–∞ —Ç–æ–∫–µ–Ω–∏
await amoCrmService.exchangeCode(code as string);
// ‚úÖ CRM –≤–∂–µ –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∞! –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ë–î
// –¢–µ–ø–µ—Ä –ø–æ–∫–∞–∑—É—î–º–æ HTML –∑ –∫–Ω–æ–ø–∫–æ—é
return res.send(`<html>...</html>`);
```

**–ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ:**
- CRM –≤–µ—Ä–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –¥–æ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ë–î
- –ù–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–Ω–æ–≤—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è

### 2. –ö–Ω–æ–ø–∫–∞ –±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ redirect

**–ö–æ–¥:**
```html
<button onclick="window.open('foryoure://amo-crm/callback?code=...', '_self')">
  Return to App
</button>
```

**–ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ:**
- –ü—Ä–∞—Ü—é—î –≤ Safari WebView
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–æ–Ω—Ç—Ä–æ–ª—é—î –ø—Ä–æ—Ü–µ—Å
- –ù–µ–º–∞—î –∑–∞–≤–∏—Å–∞–Ω—å

---

## üìÅ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### –û—Å–Ω–æ–≤–Ω—ñ —Ñ–∞–π–ª–∏:
- `AMO_CRM_CALLBACK_MANUAL_RETURN.md` - —Ñ—ñ–Ω–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –∑ –∫–æ–¥–æ–º
- `AMO_CRM_OAUTH_FINAL_STATUS.md` - —Å—Ç–∞—Ç—É—Å –≤—Å—ñ—Ö –≤–∏—Ä—ñ—à–µ–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º
- `AMO_CRM_CALLBACK_FIX_FINAL.md` - –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Å–ø—Ä–æ–±–∏ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è

### Endpoints:
- `GET /api/amo-crm/callback` - OAuth callback (–æ–±–º—ñ–Ω code + HTML –∑ –∫–Ω–æ–ø–∫–æ—é) ‚úÖ
- `POST /api/amo-crm/exchange-code` - –æ–±–º—ñ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω–∏ (–¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞) ‚úÖ
- `GET /api/amo-crm/status` - —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ‚úÖ
- `POST /api/amo-crm/disconnect` - –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è AMO CRM ‚úÖ

---

## ‚úÖ –í—Å—ñ –∫—Ä–∏—Ç–µ—Ä—ñ—ó —É—Å–ø—ñ—Ö—É –≤–∏–∫–æ–Ω–∞–Ω—ñ

1. ‚úÖ OAuth flow –ø—Ä–∞—Ü—é—î –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ –∫—ñ–Ω—Ü—è
2. ‚úÖ –ù–µ–º–∞—î –ø–æ–º–∏–ª–∫–∏ "Safari cannot open the page"
3. ‚úÖ –ù–µ–º–∞—î –∑–∞–≤–∏—Å–∞–Ω—å - –∫–Ω–æ–ø–∫–∞ –≤–∏–¥–∏–º–∞ –æ–¥—Ä–∞–∑—É
4. ‚úÖ –ö–Ω–æ–ø–∫–∞ "Return to App" –ø—Ä–∞—Ü—é—î –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–ª—ñ–∫—É
5. ‚úÖ –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î callback —Ç–∞ –æ–±—Ä–æ–±–ª—è—î –π–æ–≥–æ
6. ‚úÖ CRM –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞ - –Ω–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–Ω–æ–≤—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
7. ‚úÖ –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ
8. ‚úÖ Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

---

## üéØ –ü—ñ–¥—Å—É–º–æ–∫

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ü–†–ê–¶–Æ–Ñ –ü–û–í–ù–Ü–°–¢–Æ**

OAuth flow –¥–ª—è AMO CRM –ø–æ–≤–Ω—ñ—Å—Ç—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –º–æ–∂–µ –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—è –¥–æ AMO CRM —á–µ—Ä–µ–∑ OAuth –±–µ–∑ –∂–æ–¥–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫ –≤ Safari WebView.

**–§—ñ–Ω–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è:**
- ‚úÖ –û–±–º—ñ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω–∏ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º HTML
- ‚úÖ CRM –≤–∂–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞, –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ –¥–æ–¥–∞—Ç–æ–∫
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "Return to App" –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –æ–¥—Ä–∞–∑—É (–±–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ redirect)
- ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–æ–Ω—Ç—Ä–æ–ª—é—î –ø—Ä–æ—Ü–µ—Å –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
- ‚úÖ –ù–µ –∑'—è–≤–ª—è—î—Ç—å—Å—è –∑–Ω–æ–≤—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025
