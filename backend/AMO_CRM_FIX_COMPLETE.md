# ‚úÖ AMO CRM Fix - –í–°–ï –í–ò–ö–û–ù–ê–ù–û

## üéØ –ú–µ—Ç–∞

–ü—ñ—Å–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó AMO CRM –º–∞—é—Ç—å –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏—Å—è leads –∑–∞–º—ñ—Å—Ç—å –µ–∫—Ä–∞–Ω—É "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM".

---

## ‚úÖ –©–û –ó–†–û–ë–õ–ï–ù–û

### ‚úÖ Backend: –ó–º—ñ–Ω–µ–Ω–æ deep link

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts`

**–ó–º—ñ–Ω–∞:**
```typescript
// –ë—É–ª–æ
const deepLink = `foryoure://amo-crm/callback?code=${code}&state=${state || ''}`;

// –°—Ç–∞–ª–æ
const deepLink = `foryoure://amo-crm/callback?success=true&state=${state || ''}`;
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ö–û–ù–ê–ù–û

---

### ‚úÖ –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫: Callback Screen

**–§–∞–π–ª:** `mobile/app/amo-crm/callback.tsx`

**–ó–º—ñ–Ω–∏:**
1. ‚úÖ –î–æ–¥–∞–Ω–æ `success` –≤ `useLocalSearchParams()`
2. ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `useEffect` –¥–ª—è –æ–±—Ä–æ–±–∫–∏ `success === 'true'`
3. ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ `handleCallback` - –ø—Ä–∏–±—Ä–∞–Ω–æ –≤–∏–∫–ª–∏–∫ `amoCrmApi.exchangeCode()`
4. ‚úÖ –î–æ–¥–∞–Ω–æ `invalidateQueries` –¥–ª—è `['leads']`
5. ‚úÖ –ü—Ä–∏–±—Ä–∞–Ω–æ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–∏–π —ñ–º–ø–æ—Ä—Ç `amoCrmApi`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ö–û–ù–ê–ù–û

---

### ‚úÖ –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫: CRM Screen

**–§–∞–π–ª:** `mobile/app/(tabs)/crm.tsx`

**–ó–º—ñ–Ω–∏:**
1. ‚úÖ –î–æ–¥–∞–Ω–æ —ñ–º–ø–æ—Ä—Ç–∏ `useCallback` —Ç–∞ `useFocusEffect`
2. ‚úÖ –î–æ–¥–∞–Ω–æ `useFocusEffect` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ö–û–ù–ê–ù–û

---

## üîë –ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏

### 1. Backend: –ù–µ –ø–µ—Ä–µ–¥–∞—î code –≤ deep link ‚úÖ

**–ß–æ–º—É:**
- Backend –≤–∂–µ –æ–±–º—ñ–Ω—è–≤ `code` –Ω–∞ —Ç–æ–∫–µ–Ω–∏ –ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º HTML
- –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ë–î
- –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ `code` –≤ –¥–æ–¥–∞—Ç–æ–∫

### 2. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫: –ù–µ –≤–∏–∫–ª–∏–∫–∞—î exchange-code ‚úÖ

**–ß–æ–º—É:**
- –¢–æ–∫–µ–Ω–∏ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ backend
- –ü—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `GET /api/amo-crm/status`
- –ù–µ–º–∞—î 403 –ø–æ–º–∏–ª–∫–∏

### 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞ CRM —Å—Ç–æ—Ä—ñ–Ω–∫—É ‚úÖ

**–ß–æ–º—É:**
- –ü—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ callback —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ –Ω–µ –æ–Ω–æ–≤–∏—Ç–∏—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- `useFocusEffect` –≥–∞—Ä–∞–Ω—Ç—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤—Å—ñ—Ö –∑–º—ñ–Ω:

1. ‚úÖ Backend –æ–Ω–æ–≤–ª–µ–Ω–æ
2. ‚úÖ –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–æ
3. ‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫
4. –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫
5. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM"
6. –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å –≤ AMO CRM
7. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–†–ê–ó–†–ï–®–ò–¢–¨"
8. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "Return to App"
9. **–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ù–µ–º–∞—î 403 –ø–æ–º–∏–ª–∫–∏
   - ‚úÖ –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"
   - ‚úÖ Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è
   - ‚úÖ –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ leads –∑–∞–º—ñ—Å—Ç—å "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM"

---

## üìù –ü—ñ–¥—Å—É–º–æ–∫ –∑–º—ñ–Ω

### Backend:
- ‚úÖ `admin-panel-backend/src/routes/amo-crm.routes.ts` - –∑–º—ñ–Ω–µ–Ω–æ deep link –Ω–∞ `?success=true`

### –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫:
- ‚úÖ `mobile/app/amo-crm/callback.tsx` - –ø—Ä–∏–±—Ä–∞–Ω–æ –≤–∏–∫–ª–∏–∫ `exchangeCode`, –¥–æ–¥–∞–Ω–æ –æ–±—Ä–æ–±–∫—É `success=true`
- ‚úÖ `mobile/app/(tabs)/crm.tsx` - –¥–æ–¥–∞–Ω–æ `useFocusEffect` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É

---

## üîç –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –Ø–∫—â–æ –≤—Å–µ —â–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM":

1. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –æ–Ω–æ–≤–∏–ª–∏ deep link –≤ backend (`?success=true`) - –í–ò–ö–û–ù–ê–ù–û
2. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ `useFocusEffect` –¥–æ–¥–∞–Ω–æ –≤ `crm.tsx` - –í–ò–ö–û–ù–ê–ù–û
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ - —á–∏ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `GET /api/amo-crm/status`
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —Ç–æ–∫–µ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ë–î –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### –Ø–∫—â–æ –≤—Å–µ —â–µ 403 –ø–æ–º–∏–ª–∫–∞:

1. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—Ä–∏–±—Ä–∞–ª–∏ –≤–∏–∫–ª–∏–∫ `amoCrmApi.exchangeCode()` –∑ `callback.tsx` - –í–ò–ö–û–ù–ê–ù–û
2. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –æ–±—Ä–æ–±–ª—è—î—Ç–µ `success === 'true'` –≤ `useEffect` - –í–ò–ö–û–ù–ê–ù–û

### –Ø–∫—â–æ leads –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è:

1. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –¥–æ–¥–∞–ª–∏ `invalidateQueries({ queryKey: ['leads'] })` –≤ `callback.tsx` - –í–ò–ö–û–ù–ê–ù–û
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ `GET /api/v1/leads` –ø—Ä–∞—Ü—é—î (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ –∑ JWT —Ç–æ–∫–µ–Ω–æ–º)
3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –¥–æ—Å—Ç—É–ø –¥–æ leads (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É)

---

## ‚úÖ –í—Å—ñ –∑–º—ñ–Ω–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ!

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –î–û –¢–ï–°–¢–£–í–ê–ù–ù–Ø

–í—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–º—ñ–Ω–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ. –ü–æ—Ç—Ä—ñ–±–Ω–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏.

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025
