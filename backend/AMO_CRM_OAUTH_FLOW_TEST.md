# ‚úÖ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è OAuth Flow AMO CRM (–ø—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è Safari)

## üéØ –ú–µ—Ç–∞

–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø–æ–≤–Ω–∏–π OAuth flow –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ –∫—ñ–Ω—Ü—è –ø—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º–∏ –∑ Safari.

---

## üìã –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 1Ô∏è‚É£ –ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω

- [ ] –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –≤—ñ–¥–∫—Ä–∏—Ç–æ
- [ ] –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π (—î JWT —Ç–æ–∫–µ–Ω)
- [ ] CRM —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è
- [ ] –°—Ç–∞—Ç—É—Å AMO CRM: "–ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ"

---

### 2Ô∏è‚É£ –ó–∞–ø—É—Å–∫ OAuth flow

**–ö—Ä–æ–∫ 1:** –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM"

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] –í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä (Safari)
- [ ] –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó AMO CRM
- [ ] URL –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (`client_id`, `state`)

---

### 3Ô∏è‚É£ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ AMO CRM

**–ö—Ä–æ–∫ 2:** –í–≤–µ—Å—Ç–∏ –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å AMO CRM

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —É—Å–ø—ñ—à–Ω–æ
- [ ] –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ ("–†–ê–ó–†–ï–®–ò–¢–¨")

---

### 4Ô∏è‚É£ –ù–∞–¥–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—É

**–ö—Ä–æ–∫ 3:** –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É "–†–ê–ó–†–ï–®–ò–¢–¨" (ALLOW)

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] **–ù–ï –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –ø–æ–º–∏–ª–∫–∞ "Safari cannot open the page"**
- [ ] –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º "Redirecting to app..."
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ deep link `foryoure://amo-crm/callback?code=...`

---

### 5Ô∏è‚É£ –û–±—Ä–æ–±–∫–∞ callback –≤ –º–æ–±—ñ–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É

**–ö—Ä–æ–∫ 4:** –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î deep link

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –≤—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- [ ] –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –µ–∫—Ä–∞–Ω –æ–±—Ä–æ–±–∫–∏ callback
- [ ] –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è `POST /api/amo-crm/exchange-code` –∑ JWT —Ç–æ–∫–µ–Ω–æ–º
- [ ] –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

---

### 6Ô∏è‚É£ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É

**–ö—Ä–æ–∫ 5:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å AMO CRM

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"
- [ ] –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è domain —Ç–∞ accountId
- [ ] –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª—ñ

**API —Ç–µ—Å—Ç:**
```bash
curl -X GET https://admin.foryou-realestate.com/api/amo-crm/status \
  -H "Authorization: Bearer <user_jwt_token>"
```

**–û—á—ñ–∫—É–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "success": true,
  "data": {
    "connected": true,
    "hasTokens": true,
    "domain": "reforyou.amocrm.ru",
    "accountId": "31920194"
  }
}
```

---

### 7Ô∏è‚É£ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è leads

**–ö—Ä–æ–∫ 6:** –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è leads

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ
- [ ] –í—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫—É
- [ ] –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î

---

### 8Ô∏è‚É£ –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è AMO CRM (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

**–ö—Ä–æ–∫ 7:** –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ –∫–Ω–æ–ø–∫—É "–í—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM"

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] Endpoint `POST /api/amo-crm/disconnect` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ
- [ ] –¢–æ–∫–µ–Ω–∏ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è –∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
- [ ] –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ"

---

## üîç –©–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤ –ª–æ–≥–∞—Ö

### Backend –ª–æ–≥–∏

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ backend –ø—Ä–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—ñ:
- [ ] –û—Ç—Ä–∏–º–∞–Ω–Ω—è callback –∑ `code`
- [ ] –û–±–º—ñ–Ω `code` –Ω–∞ —Ç–æ–∫–µ–Ω–∏
- [ ] –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –≤ –ë–î
- [ ] –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ deep link (HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞)

### –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –ª–æ–≥–∏

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ –º–æ–±—ñ–ª—å–Ω–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É:
- [ ] –û—Ç—Ä–∏–º–∞–Ω–Ω—è deep link callback
- [ ] –í–∏–∫–ª–∏–∫ `POST /api/amo-crm/exchange-code`
- [ ] –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É AMO CRM
- [ ] –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è leads

---

## ‚ö†Ô∏è –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏

### –ü—Ä–æ–±–ª–µ–º–∞ 1: HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î

**–°–∏–º–ø—Ç–æ–º–∏:**
- –í—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞, –∞–ª–µ –Ω–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ deep link

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ JavaScript –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ deep link –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π –≤ `app.json` (Expo)

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ

**–°–∏–º–ø—Ç–æ–º–∏:**
- –ü—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è AMO CRM —Ç–æ–∫–µ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å—ñ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ `POST /api/amo-crm/exchange-code` –∑–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏ –∑ `userId` –∑ JWT
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ `GET /api/amo-crm/status` –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–æ–∫–µ–Ω–∏ –¥–ª—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: 401 –Ω–∞ exchange-code endpoint

**–°–∏–º–ø—Ç–æ–º–∏:**
- –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î 401 –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É `POST /api/amo-crm/exchange-code`

**–†—ñ—à–µ–Ω–Ω—è:**
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ JWT —Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ header: `Authorization: Bearer <token>`
- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª—ñ–¥–Ω–∏–π —Ç–∞ –Ω–µ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä—ñ—ó —É—Å–ø—ñ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

1. ‚úÖ OAuth flow –ø—Ä–∞—Ü—é—î –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ –∫—ñ–Ω—Ü—è
2. ‚úÖ –ù–µ–º–∞—î –ø–æ–º–∏–ª–∫–∏ "Safari cannot open the page"
3. ‚úÖ HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ deep link
4. ‚úÖ –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î callback —Ç–∞ –æ–±—Ä–æ–±–ª—è—î –π–æ–≥–æ
5. ‚úÖ –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
6. ‚úÖ –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ
7. ‚úÖ Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
8. ‚úÖ –í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è AMO CRM –ø—Ä–∞—Ü—é—î

---

## üìù –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

**–î–∞—Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** _______________

**–¢–µ—Å—Ç—É–≤–∞—á:** _______________

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- [ ] ‚úÖ –£—Å–ø—ñ—à–Ω–æ
- [ ] ‚ùå –ü–æ–º–∏–ª–∫–∏ (–æ–ø–∏—à—ñ—Ç—å –Ω–∏–∂—á–µ)

**–í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏:**
1. ________________________________
2. ________________________________
3. ________________________________

**–ü—Ä–∏–º—ñ—Ç–∫–∏:**
________________________________
________________________________

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025
