# ‚úÖ AMO CRM OAuth Integration - COMPLETE

## üéâ –°—Ç–∞—Ç—É—Å: –í–ò–†–Ü–®–ï–ù–û

–í—Å—ñ –ø—Ä–æ–±–ª–µ–º–∏ –∑ OAuth flow –¥–ª—è AMO CRM –≤–∏—Ä—ñ—à–µ–Ω—ñ. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –º–æ–∂–µ –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—è –¥–æ AMO CRM —á–µ—Ä–µ–∑ OAuth –±–µ–∑ –ø–æ–º–∏–ª–æ–∫.

---

## üìã –©–æ –±—É–ª–æ –≤–∏—Ä—ñ—à–µ–Ω–æ

### 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Redirect URI –≤ AMO CRM
- ‚úÖ Redirect URI: `https://admin.foryou-realestate.com/api/amo-crm/callback`
- ‚úÖ –î—Ä—É–≥–µ –ø–æ–ª–µ: `https://admin.foryou-realestate.com/api/amo-crm/disconnect`

### 2. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è callback endpoint
- ‚úÖ –ó–∞–º—ñ–Ω–µ–Ω–æ `res.redirect()` –Ω–∞ HTML —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ JavaScript redirect
- ‚úÖ –î–æ–¥–∞–Ω–æ —Ç—Ä–∏ –º–µ—Ç–æ–¥–∏ redirect –¥–ª—è Safari WebView:
  1. `location.href` (–±–µ–∑ window)
  2. `window.location.replace()`
  3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∫–ª—ñ–∫ –ø–æ `<a>` —Ç–µ–≥—É
- ‚úÖ –î–æ–¥–∞–Ω–æ fallback –∫–Ω–æ–ø–∫—É "Return to App" –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–ª—ñ–∫—É

### 3. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è UI/UX
- ‚úÖ –°—Ç–∏–ª—ñ–∑–æ–≤–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –∑ —Ç—ñ–Ω–Ω—é —Ç–∞ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–∏–º–∏ –∫—É—Ç–∞–º–∏
- ‚úÖ –ö–æ–ª—å–æ—Ä–æ–≤–µ –≤–∏–¥—ñ–ª–µ–Ω–Ω—è —É—Å–ø—ñ—Ö—É (–∑–µ–ª–µ–Ω–∏–π) —Ç–∞ –ø–æ–º–∏–ª–æ–∫ (—á–µ—Ä–≤–æ–Ω–∏–π)
- ‚úÖ Responsive –¥–∏–∑–∞–π–Ω –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
- ‚úÖ –°–∏—Å—Ç–µ–º–Ω—ñ —à—Ä–∏—Ñ—Ç–∏ Apple –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –≤–∏–≥–ª—è–¥—É

---

## üîÑ –ü–æ–≤–Ω–∏–π OAuth Flow

### –ö—Ä–æ–∫ 1: –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM" –≤ –º–æ–±—ñ–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É
2. –í—ñ–¥–∫—Ä–∏–≤–∞—î—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä (Safari) –∑ —Ñ–æ—Ä–º–æ—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó AMO CRM

### –ö—Ä–æ–∫ 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –≤ AMO CRM
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–≤–æ–¥–∏—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å AMO CRM
2. –ù–∞—Ç–∏—Å–∫–∞—î "–†–ê–ó–†–ï–®–ò–¢–¨" (ALLOW)

### –ö—Ä–æ–∫ 3: Callback –æ–±—Ä–æ–±–∫–∞
1. AMO CRM –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ `https://admin.foryou-realestate.com/api/amo-crm/callback?code=...`
2. Backend –æ–±—Ä–æ–±–ª—è—î callback:
   - –û–±–º—ñ–Ω—é—î `code` –Ω–∞ —Ç–æ–∫–µ–Ω–∏
   - –ü–æ–≤–µ—Ä—Ç–∞—î HTML —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑ JavaScript redirect
3. JavaScript –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ deep link `foryoure://amo-crm/callback?code=...`
4. –Ø–∫—â–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π redirect –Ω–µ —Å–ø—Ä–∞—Ü—é—î - –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ "Return to App"

### –ö—Ä–æ–∫ 4: –û–±—Ä–æ–±–∫–∞ –≤ –º–æ–±—ñ–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É
1. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î deep link
2. –í–∏–∫–ª–∏–∫–∞—î `POST /api/amo-crm/exchange-code` –∑ JWT —Ç–æ–∫–µ–Ω–æ–º
3. Backend –∑–±–µ—Ä—ñ–≥–∞—î —Ç–æ–∫–µ–Ω–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
4. –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"

---

## üìÅ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

### –û—Å–Ω–æ–≤–Ω—ñ —Ñ–∞–π–ª–∏:
- `AMO_CRM_CALLBACK_FIX_FINAL.md` - —Ñ—ñ–Ω–∞–ª—å–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∑ –∫–æ–¥–æ–º
- `AMO_CRM_CALLBACK_SAFARI_FIX.md` - –¥–µ—Ç–∞–ª—å–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è Safari
- `AMO_CRM_OAUTH_FLOW_TEST.md` - —á–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- `AMO_CRM_URLS_SETUP.md` - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è URL –≤ AMO CRM

### Endpoints:
- `GET /api/amo-crm/callback` - OAuth callback (HTML redirect)
- `POST /api/amo-crm/exchange-code` - –æ–±–º—ñ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω–∏
- `GET /api/amo-crm/status` - —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- `POST /api/amo-crm/disconnect` - –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è AMO CRM

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä—ñ—ó —É—Å–ø—ñ—Ö—É

1. ‚úÖ OAuth flow –ø—Ä–∞—Ü—é—î –≤—ñ–¥ –ø–æ—á–∞—Ç–∫—É –¥–æ –∫—ñ–Ω—Ü—è
2. ‚úÖ –ù–µ–º–∞—î –ø–æ–º–∏–ª–∫–∏ "Safari cannot open the page"
3. ‚úÖ HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î –Ω–∞ deep link
4. ‚úÖ Fallback –∫–Ω–æ–ø–∫–∞ "Return to App" –ø—Ä–∞—Ü—é—î –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–ª—ñ–∫—É (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `<button onclick>`)
5. ‚úÖ –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –æ—Ç—Ä–∏–º—É—î callback —Ç–∞ –æ–±—Ä–æ–±–ª—è—î –π–æ–≥–æ
6. ‚úÖ –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
7. ‚úÖ –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ
8. ‚úÖ Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –ø—ñ—Å–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025 - –≤–∏—Ä—ñ—à–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º—É –∑ –∫–Ω–æ–ø–∫–æ—é "Return to App"

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

### 1. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤
- –ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ `user_id` —á–µ—Ä–µ–∑ `state` –ø–∞—Ä–∞–º–µ—Ç—Ä –≤ OAuth flow
- –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç–æ–∫–µ–Ω–∏ –∑ `userId` –≤ `AmoCrmToken` entity
- –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Ç–æ–∫–µ–Ω–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ `GET /api/amo-crm/status`

### 2. –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è OAuth flow
- –í—ñ–¥—Å—Ç–µ–∂—É–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏ redirect
- –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ —É—Å–ø—ñ—à–Ω—ñ—Å—Ç—å –ø—ñ–¥–∫–ª—é—á–µ–Ω—å

### 3. –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è UX
- –î–æ–¥–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—ñ–¥ —á–∞—Å –æ–±—Ä–æ–±–∫–∏ callback
- –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
- –î–æ–¥–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ—ó —Å–ø—Ä–æ–±–∏ –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

---

## üìù –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### –ú–µ—Ç–æ–¥–∏ redirect (—É –ø–æ—Ä—è–¥–∫—É —Å–ø—Ä–æ–±–∏):
1. `location.href = deepLink` - –Ω–∞–π—à–≤–∏–¥—à–∏–π, –ø—Ä–∞—Ü—é—î –≤ –±—ñ–ª—å—à–æ—Å—Ç—ñ –≤–∏–ø–∞–¥–∫—ñ–≤
2. `window.location.replace(deepLink)` - –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è Safari
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∫–ª—ñ–∫ –ø–æ `<a>` —Ç–µ–≥—É - –¥–ª—è WebView
4. Fallback –∫–Ω–æ–ø–∫–∞ - –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∫–ª—ñ–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏

### –ë–µ–∑–ø–µ–∫–∞:
- –ï–∫—Ä–∞–Ω—É–≤–∞–Ω–Ω—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —á–µ—Ä–µ–∑ `encodeURIComponent()`
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è `code` –ø–µ—Ä–µ–¥ –æ–±–º—ñ–Ω–æ–º –Ω–∞ —Ç–æ–∫–µ–Ω–∏
- JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –¥–ª—è `POST /api/amo-crm/exchange-code`

---

## üéØ –ü—ñ–¥—Å—É–º–æ–∫

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–°–ï –ü–†–ê–¶–Æ–Ñ

OAuth flow –¥–ª—è AMO CRM –ø–æ–≤–Ω—ñ—Å—Ç—é —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–∏–π. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –º–æ–∂–µ –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—è –¥–æ AMO CRM —á–µ—Ä–µ–∑ OAuth –±–µ–∑ –ø–æ–º–∏–ª–æ–∫ –≤ Safari WebView.

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025
