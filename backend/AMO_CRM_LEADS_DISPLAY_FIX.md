# üîß –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è leads –ø—ñ—Å–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó AMO CRM

## üêõ –ü—Ä–æ–±–ª–µ–º–∏

1. **403 –ø–æ–º–∏–ª–∫–∞** –ø—Ä–∏ `POST /api/amo-crm/exchange-code` - –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –æ–±–º—ñ–Ω—è—Ç–∏ code –∑–Ω–æ–≤—É
2. **–ù–µ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è leads** - –ø—ñ—Å–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤—Å–µ —â–µ –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM"
3. **–°—Ç–∞—Ç—É—Å –Ω–µ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è** - –ø—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ callback —Å—Ç–∞—Ç—É—Å –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è "–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ"

---

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### 1. Backend –Ω–µ –ø–µ—Ä–µ–¥–∞—î code –≤ deep link

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts`

**–ó–º—ñ–Ω–∏—Ç–∏:**
```typescript
// –ë—É–ª–æ
const deepLink = `foryoure://amo-crm/callback?code=${code}&state=${state || ''}`;

// –°—Ç–∞–ª–æ
// ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –ù–µ –ø–µ—Ä–µ–¥–∞—î–º–æ code, –±–æ —Ç–æ–∫–µ–Ω–∏ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ
const deepLink = `foryoure://amo-crm/callback?success=true&state=${state || ''}`;
```

### 2. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î exchange-code

**–§–∞–π–ª:** `mobile/app/amo-crm/callback.tsx`

**–ó–º—ñ–Ω–∏—Ç–∏ `handleCallback`:**
```typescript
// –ë—É–ª–æ
const handleCallback = async (code: string) => {
  await amoCrmApi.exchangeCode(code); // ‚ùå 403 –ø–æ–º–∏–ª–∫–∞!
  await queryClient.invalidateQueries({ queryKey: ['amo-crm-status'] });
};

// –°—Ç–∞–ª–æ
const handleCallback = async (code: string | undefined, success: string | undefined) => {
  // ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: Backend –≤–∂–µ –æ–±–º—ñ–Ω—è–≤ code –Ω–∞ —Ç–æ–∫–µ–Ω–∏
  // –ü—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —Ç–∞ leads
  await queryClient.invalidateQueries({ queryKey: ['amo-crm-status'] });
  await queryClient.invalidateQueries({ queryKey: ['leads'] });
};
```

**–û–Ω–æ–≤–∏—Ç–∏ `useEffect`:**
```typescript
useEffect(() => {
  if (errorParam) {
    setStatus('error');
    return;
  }

  // –Ø–∫—â–æ success=true - backend –≤–∂–µ –æ–±–º—ñ–Ω—è–≤ code –Ω–∞ —Ç–æ–∫–µ–Ω–∏
  if (success === 'true') {
    handleCallback(undefined, success);
  } else if (code && typeof code === 'string') {
    // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –≤–µ—Ä—Å—ñ–π
    handleCallback(code, undefined);
  } else {
    setStatus('error');
  }
}, [code, success, errorParam]);
```

### 3. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞ CRM —Å—Ç–æ—Ä—ñ–Ω–∫—É

**–§–∞–π–ª:** `mobile/app/(tabs)/crm.tsx`

**–î–æ–¥–∞—Ç–∏ `useFocusEffect`:**
```typescript
import { useFocusEffect } from 'expo-router';

// –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å AMO CRM –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É (–ø—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ callback)
useFocusEffect(
  useCallback(() => {
    if (!authLoading && isAuthenticated) {
      refetchAmoStatus();
    }
  }, [authLoading, isAuthenticated, refetchAmoStatus])
);
```

---

## üîë –ö–ª—é—á–æ–≤—ñ –∑–º—ñ–Ω–∏

### 1. Backend: –ù–µ –ø–µ—Ä–µ–¥–∞—î code –≤ deep link

**–ß–æ–º—É:**
- Backend –≤–∂–µ –æ–±–º—ñ–Ω—è–≤ code –Ω–∞ —Ç–æ–∫–µ–Ω–∏
- –¢–æ–∫–µ–Ω–∏ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –ë–î
- –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ code –≤ –¥–æ–¥–∞—Ç–æ–∫

### 2. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫: –ù–µ –≤–∏–∫–ª–∏–∫–∞—î exchange-code

**–ß–æ–º—É:**
- –¢–æ–∫–µ–Ω–∏ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ backend
- –ü—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `GET /api/amo-crm/status`
- –ù–µ–º–∞—î 403 –ø–æ–º–∏–ª–∫–∏

### 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ

**–ß–æ–º—É:**
- –ü—ñ—Å–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ callback —Å—Ç–∞—Ç—É—Å –º–æ–∂–µ –Ω–µ –æ–Ω–æ–≤–∏—Ç–∏—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- `useFocusEffect` –≥–∞—Ä–∞–Ω—Ç—É—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

1. ‚úÖ –ù–µ–º–∞—î 403 –ø–æ–º–∏–ª–∫–∏ - –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î `exchange-code`
2. ‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è - `GET /api/amo-crm/status` –ø–æ–∫–∞–∑—É—î, —â–æ CRM –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞
3. ‚úÖ Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è - –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É
4. ‚úÖ –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ leads - –∑–∞–º—ñ—Å—Ç—å "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM"

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫
2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM"
3. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ AMO CRM
4. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–†–ê–ó–†–ï–®–ò–¢–¨"
5. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Return to App"
6. **–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ù–µ–º–∞—î 403 –ø–æ–º–∏–ª–∫–∏
   - –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"
   - Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è
   - –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ leads –∑–∞–º—ñ—Å—Ç—å "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM"

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025
