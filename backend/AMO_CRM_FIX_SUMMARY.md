# üîß –ü—ñ–¥—Å—É–º–æ–∫ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è leads –ø—ñ—Å–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

## üêõ –ü—Ä–æ–±–ª–µ–º–∏

1. **403 –ø–æ–º–∏–ª–∫–∞** - `POST /api/amo-crm/exchange-code` –Ω–µ –ø—Ä–∞—Ü—é—î
2. **–ù–µ –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è leads** - –ø—ñ—Å–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≤—Å–µ —â–µ "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM"
3. **–î—Ä—É–≥–∏–π –¥–æ–¥–∞—Ç–æ–∫ –≤ —Å–∏–º—É–ª—è—Ç–æ—Ä—ñ** - –º–æ–∂–ª–∏–≤–æ —á–µ—Ä–µ–∑ –æ–¥–Ω–æ—á–∞—Å–Ω–∏–π –∑–∞–ø—É—Å–∫ –Ω–∞—Ç–∏–≤–Ω–æ—ó –∑–±—ñ—Ä–∫–∏ —Ç–∞ Expo Go

---

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. Backend: –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ code –≤ deep link

**–§–∞–π–ª:** `admin-panel-backend/src/routes/amo-crm.routes.ts`

**–ó–Ω–∞–π—Ç–∏:**
```typescript
const deepLink = `foryoure://amo-crm/callback?code=${code}&state=${state || ''}`;
```

**–ó–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞:**
```typescript
// ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –ù–µ –ø–µ—Ä–µ–¥–∞—î–º–æ code, –±–æ —Ç–æ–∫–µ–Ω–∏ –≤–∂–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ
const deepLink = `foryoure://amo-crm/callback?success=true&state=${state || ''}`;
```

### 2. –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫: –ù–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ exchange-code

**–§–∞–π–ª:** `mobile/app/amo-crm/callback.tsx`

**–û–Ω–æ–≤–ª–µ–Ω–æ:**
- ‚úÖ `handleCallback` —Ç–µ–ø–µ—Ä –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î `amoCrmApi.exchangeCode()`
- ‚úÖ –ü—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `invalidateQueries`
- ‚úÖ –û–±—Ä–æ–±–ª—è—î –ø–∞—Ä–∞–º–µ—Ç—Ä `success=true` –∑ deep link

### 3. –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞ CRM —Å—Ç–æ—Ä—ñ–Ω–∫—É

**–§–∞–π–ª:** `mobile/app/(tabs)/crm.tsx`

**–î–æ–¥–∞–Ω–æ:**
- ‚úÖ `useFocusEffect` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É
- ‚úÖ –°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –∑ callback

---

## üìù –©–æ –∑—Ä–æ–±–ª–µ–Ω–æ

### Backend (–≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–æ):
- ‚úÖ –û–±–º—ñ–Ω code –Ω–∞ —Ç–æ–∫–µ–Ω–∏ –ü–ï–†–ï–î –ø–æ–∫–∞–∑–æ–º HTML
- ‚úÖ –ù–µ –ø–µ—Ä–µ–¥–∞—î code –≤ deep link (–ø–µ—Ä–µ–¥–∞—î `success=true`)

### –ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ (–≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–æ):
- ‚úÖ `callback.tsx` - –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î `exchange-code`, –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î —Å—Ç–∞—Ç—É—Å
- ‚úÖ `crm.tsx` - –¥–æ–¥–∞–Ω–æ `useFocusEffect` –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è backend:

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫
2. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ AMO CRM"
3. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ AMO CRM
4. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–†–ê–ó–†–ï–®–ò–¢–¨"
5. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "Return to App"
6. **–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ù–µ–º–∞—î 403 –ø–æ–º–∏–ª–∫–∏
   - ‚úÖ –°—Ç–∞—Ç—É—Å AMO CRM –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –Ω–∞ "–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ"
   - ‚úÖ Leads –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è
   - ‚úÖ –ü–æ–∫–∞–∑—É—î—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ leads –∑–∞–º—ñ—Å—Ç—å "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å –ê–ú–û CRM"

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ

**Backend –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏:**
- –ó–º—ñ–Ω–∏—Ç–∏ deep link –∑ `?code=...` –Ω–∞ `?success=true` –≤ `admin-panel-backend/src/routes/amo-crm.routes.ts`

**–ú–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫ –≤–∂–µ –æ–Ω–æ–≤–ª–µ–Ω–æ:**
- `callback.tsx` - –æ–±—Ä–æ–±–ª—è—î `success=true`
- `crm.tsx` - –æ–Ω–æ–≤–ª—é—î —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ —Ñ–æ–∫—É—Å—ñ

---

**–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:** –°—ñ—á–µ–Ω—å 2025
