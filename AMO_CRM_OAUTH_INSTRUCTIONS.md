# AMO CRM OAuth - –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π —Å–ø–æ—Å—ñ–± –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π OAuth 2.0)

### –ö—Ä–æ–∫ 1: –û—Ç—Ä–∏–º–∞—Ç–∏ Authorization code

–í—ñ–¥–∫—Ä–∏–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ —Ü–µ–π URL:

```
https://www.amocrm.ru/oauth?client_id=2912780f-a1e4-4d5d-a069-ee01422d8bef&state=test123&mode=popup
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**
- `client_id` - ID —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó (2912780f-a1e4-4d5d-a069-ee01422d8bef)
- `state` - –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ CSRF (–º–æ–∂–µ –±—É—Ç–∏ –±—É–¥—å-—è–∫–∏–π —Ä—è–¥–æ–∫)
- `mode` - `popup` (–∑–∞–∫—Ä–∏–≤–∞—î popup –ø—ñ—Å–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó) –∞–±–æ `post_message`

### –ö—Ä–æ–∫ 2: –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—è –≤ AMO CRM

1. –£ popup –≤—ñ–∫–Ω—ñ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—è
2. –í–∏–±–µ—Ä—ñ—Ç—å –∞–∫–∫–∞—É–Ω—Ç `reforyou.amocrm.ru`
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–†–∞–∑—Ä–µ—à–∏—Ç—å" (Allow)

### –ö—Ä–æ–∫ 3: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó

AMO CRM –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –≤–∞—Å –Ω–∞:
```
https://foryou-realestate.com/api/v1/integrations/amo-crm/callback?code=–ê–í–¢–û–†–ò–ó–ê–¶–Ü–ô–ù–ò–ô_–ö–û–î&referer=reforyou.amocrm.ru&state=test123
```

### –ö—Ä–æ–∫ 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –æ–±–º—ñ–Ω –Ω–∞ —Ç–æ–∫–µ–Ω–∏

Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
1. –û—Ç—Ä–∏–º–∞—î –∫–æ–¥ –∑ URL
2. –û–±–º—ñ–Ω—è—î –π–æ–≥–æ –Ω–∞ access_token —Ç–∞ refresh_token —á–µ—Ä–µ–∑ POST `/oauth2/access_token`
3. –ó–±–µ—Ä–µ–∂–µ —Ç–æ–∫–µ–Ω–∏ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö

---

## üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### Redirect URI –≤ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó AMO CRM:
```
https://foryou-realestate.com/api/v1/integrations/amo-crm/callback
```

**–í–∞–∂–ª–∏–≤–æ:** Redirect URI –º–∞—î —Ç–æ—á–Ω–æ —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏ –∑ —Ç–∏–º, —â–æ –≤–∫–∞–∑–∞–Ω–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó!

### –î–∞–Ω—ñ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó:
```
Domain: reforyou.amocrm.ru
Client ID: 2912780f-a1e4-4d5d-a069-ee01422d8bef
Client Secret: (–≤ .env —Ñ–∞–π–ª—ñ)
Redirect URI: https://foryou-realestate.com/api/v1/integrations/amo-crm/callback
```

---

## üìã –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –û–±–º—ñ–Ω API –∫–ª—é—á–∞

–Ø–∫—â–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π OAuth –Ω–µ –ø—Ä–∞—Ü—é—î, –º–æ–∂–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ–±–º—ñ–Ω API –∫–ª—é—á–∞:

**POST** `https://reforyou.amocrm.ru/oauth2/exchange_api_key`

```json
{
  "login": "email@example.com",
  "api_key": "–≤–∞—à-api-–∫–ª—é—á",
  "client_uuid": "2912780f-a1e4-4d5d-a069-ee01422d8bef",
  "client_secret": "–≤–∞—à-secret"
}
```

**–í–∞–∂–ª–∏–≤–æ:** 
- API –∫–ª—é—á –º–∞—î –Ω–∞–ª–µ–∂–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É –∑ email, —è–∫–∏–π –≤–∏ –≤–∫–∞–∑—É—î—Ç–µ
- Email –º–∞—î –±—É—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º (—Ç–æ–π, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤—Ö–æ–¥—É –≤ AMO CRM)

---

## üß™ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤

–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, —Ç–æ–∫–µ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—ñ `amo_tokens`:

```sql
SELECT "accountId", "expiresAt", "createdAt" FROM amo_tokens;
```

---

## üîó –ö–æ—Ä–∏—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è AMO CRM OAuth](https://www.amocrm.ru/developers/content/oauth/step-by-step)
- Backend endpoint: `https://foryou-realestate.com/api/v1/integrations/amo-crm/callback`

